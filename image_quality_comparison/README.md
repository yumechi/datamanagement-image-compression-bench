# 画像品質比較プログラム

## 概要

このプログラムは、「datamanagement」本の執筆のために、WebP画像の品質設定による圧縮効果とファイルサイズの関係を分析するベンチマークツールです。PNG画像をベースラインとして、異なる品質レベル（100%〜50%）でWebPに変換し、圧縮効果を比較検証します。

## 機能

### 主な処理

1. **ランダム画像生成**: ImageMagickを使用して1024x1024のランダムノイズPNG画像を指定枚数生成（4並列処理）
2. **品質別WebP変換**: PNG画像を複数の品質レベル（100%, 90%, 80%, 70%, 60%, 50%）でWebPに変換（4並列処理）
3. **統計計算**: 各品質レベルでのファイルサイズ統計と圧縮率を算出
4. **データ出力**: 指定されたラウンド数の実行結果をCSVファイルに出力
5. **自動クリーンアップ**: 各ラウンド後に画像ファイルを自動削除してディスク容量を節約

### 出力される統計データ

- **実行回数**: ベンチマーク実行回数（指定されたラウンド数）
- **品質**: WebP品質レベル（100%, 90%, 80%, 70%, 60%, 50%）
- **合計サイズ**: 指定枚数の画像の合計ファイルサイズ
- **平均サイズ**: 1枚あたりの平均ファイルサイズ
- **最小サイズ**: 最も小さいファイルサイズ
- **最大サイズ**: 最も大きいファイルサイズ
- **中央値**: ファイルサイズの中央値
- **圧縮率**: PNG基準での圧縮率（小さいほど高圧縮）

## 技術仕様

- **言語**: Rust
- **外部依存**: ImageMagick (`convert`コマンド)
- **画像サイズ**: 1024x1024ピクセル
- **画像数**: 各実行で指定された枚数生成（デフォルト: 100枚）
- **実行回数**: 指定されたラウンド数（デフォルト: 10回）
- **並列処理**: 4並列でタスクを実行し、高速化を実現
- **品質レベル**: 100%から50%まで10%刻み（6段階）

## 依存関係

```toml
csv = "1.3"           # CSV出力
serde = "1.0"         # データシリアライゼーション
rand = "0.8"          # ランダム値生成
tokio = "1.0"         # 非同期ランタイム
```

## 実行方法

### 基本実行

```bash
# デフォルト設定で実行（100枚の画像、10ラウンド、6品質レベル）
cargo run
```

### コマンドライン引数

```bash
# ヘルプを表示
cargo run -- --help

# 画像枚数を指定（50枚の画像、10ラウンド）
cargo run -- 50

# 画像枚数とラウンド数を両方指定（200枚の画像、5ラウンド）
cargo run -- 200 5

# テスト用の小さな実行（2枚の画像、1ラウンド）
cargo run -- 2 1
```

### 使用方法

```
cargo run -- [画像枚数] [ラウンド数]
```

**引数:**
- `画像枚数`: 各ラウンドで生成する画像の枚数（デフォルト: 100）
- `ラウンド数`: ベンチマークの実行回数（デフォルト: 10）

**注意事項:**
- 画像枚数とラウンド数は正の整数で指定してください
- 4並列処理により、従来より高速に実行されます
- 実験用画像ファイルは統計取得後に自動削除されます
- 6つの品質レベルで変換するため、単一品質の6倍の処理時間がかかります

## 出力ファイル

- **image_comparison_quality_results.csv**: メインプログラムの統計データが記録されるCSVファイル
- **images_run_N/**: 各実行回数ごとの画像ファイルが格納されるディレクトリ（統計取得後に自動削除）
- **image_comparison_quality_test_results.csv**: テストプログラム（test_program）用の統計データファイル

## 前提条件

システムにImageMagickがインストールされている必要があります：

```bash
# Ubuntu/Debian
sudo apt-get install imagemagick

# macOS
brew install imagemagick
```

## 利用可能なプログラム

### メインプログラム（image_comparison_quality）
```bash
# フルスケールベンチマーク（デフォルト: 100枚、10ラウンド、6品質レベル）
cargo run

# カスタム設定
cargo run -- 50 5  # 50枚、5ラウンド
```

### テストプログラム（test_program）
```bash
# 軽量テスト（デフォルト: 5枚、1ラウンド、3品質レベル）
cargo run --bin test_program

# カスタムテスト
cargo run --bin test_program -- 10 2  # 10枚、2ラウンド
```

## プロジェクト目的

本プログラムはWebP画像の品質設定による圧縮効果を定量的に分析し、データ管理における品質と容量のトレードオフを理解するための定量的データを提供することを目的としています。メインプログラムで本格的な品質比較を、テストプログラムで動作確認や軽量テストを実行できます。

## 期待される結果

- 品質レベルが下がるほど、ファイルサイズが小さくなることの確認
- 品質レベルごとの圧縮率の定量的な測定
- 品質と圧縮率の関係性の可視化データ取得
- データ保存戦略における最適品質レベルの判断材料