# file_write_benchmark - ファイル書き込みベンチマーク

## プロジェクト概要

このディレクトリは「datamanagement」本のための**ファイル書き込みベンチマークツール**です。
ディスクへの大量ファイル書き込み性能を測定し、ストレージやファイルシステムの性能を定量的に評価します。

## 技術スタック

### 言語・フレームワーク
- **言語**: Rust
- **Edition**: 2024
- **非同期処理**: なし（同期I/Oで正確な測定）

### 主要依存関係
```toml
csv = "1.3"           # CSV出力用
serde = "1.0"         # データシリアライゼーション（derive feature有効）
```

### 外部依存
なし（標準ライブラリのみ使用）

## ビルド・実行方法

### ビルド
```bash
cd file_write_benchmark
cargo build --release
```

### 実行方法

#### メインプログラム（file_write_benchmark）
```bash
# デフォルト実行（100,000ファイル、10回実行）
cargo run -- /tmp/benchmark

# 別のディスクに書き込み
cargo run -- F:/benchmark

# WSL環境でWindowsディスクにアクセス
cargo run -- /mnt/f/benchmark

# カスタム設定
cargo run -- <書き込み先パス> [ファイル数] [実行回数]

# 例: 50,000ファイル、5回実行
cargo run -- /tmp/benchmark 50000 5

# 例: テスト用（1,000ファイル、3回実行）
cargo run -- /tmp/benchmark 1000 3
```

#### テストプログラム（test_program）
```bash
# 軽量テスト実行（デフォルト: 1,000ファイル、3回実行）
cargo run --bin test_program -- /tmp/benchmark

# カスタムテスト
cargo run --bin test_program -- <書き込み先パス> [ファイル数] [実行回数]

# 例: 500ファイル、2回実行
cargo run --bin test_program -- /tmp/benchmark 500 2
```

## プログラム構成

### バイナリ

1. **file_write_benchmark** (`src/main.rs`)
   - フルスケールベンチマーク
   - デフォルト: 100,000ファイル、10回実行
   - 進捗表示: 10,000ファイルごと
   - 出力: `file_write_benchmark_results.csv`

2. **test_program** (`src/test.rs`)
   - 軽量テスト用
   - デフォルト: 1,000ファイル、3回実行
   - 進捗表示: 100ファイルごと
   - 出力: `file_write_benchmark_test_results.csv`

## 処理フロー

1. **引数解析**: 書き込み先パス、ファイル数、実行回数を取得
2. **親ディレクトリ確認**: 書き込み先の親ディレクトリが存在するか検証
3. **ベンチマーク実行**:
   - 実行ごとにサブディレクトリを作成（`run_1`, `run_2`, ...）
   - ファイル作成開始から完了までの時間を測定
   - 1バイトのファイルを指定数作成
   - 処理速度（ファイル/秒）を計算
4. **CSV出力**: 測定結果をCSVファイルに記録
5. **クリーンアップ**: 各実行後にテストファイルを自動削除

## ファイル仕様

### 作成するファイル
- **サイズ**: 1バイト（最小単位）
- **内容**: 0x00（ゼロバイト）
- **命名規則**: `file_00000000.dat`〜`file_99999999.dat`（8桁ゼロパディング）
- **配置**: `<書き込み先パス>/run_N/file_XXXXXXXX.dat`

### ディレクトリ構造
```
<書き込み先パス>/
├── run_1/
│   ├── file_00000000.dat
│   ├── file_00000001.dat
│   └── ...
├── run_2/
│   └── ...（実行後に自動削除）
└── ...
```

## 測定メトリクス

### 出力データ形式

#### CSVカラム
- **run_number**: 実行回数（1, 2, 3, ...）
- **target_path**: 書き込み先パス
- **file_count**: 作成したファイル数
- **total_time_ms**: 処理時間（ミリ秒）
- **files_per_second**: 処理速度（ファイル/秒）

### 処理速度の計算
```rust
files_per_second = file_count / elapsed_seconds
```

### 出力ファイル
- `file_write_benchmark_results.csv`: メインプログラムの結果
- `file_write_benchmark_test_results.csv`: テストプログラムの結果

## 実行時間の目安

### 標準設定（100,000ファイル×10回）

| ストレージ種類 | 1回あたり | 合計（10回） |
|--------------|----------|------------|
| NVMe SSD | 3-10秒 | 30-100秒 |
| SATA SSD | 5-20秒 | 50-200秒 |
| HDD | 50-200秒 | 500-2000秒 |
| ネットワーク | 100-1000秒 | 1000-10000秒 |

### テスト設定（1,000ファイル×3回）

| ストレージ種類 | 合計（3回） |
|--------------|-----------|
| NVMe SSD | 1秒未満 |
| SATA SSD | 1-3秒 |
| HDD | 3-10秒 |

## 開発時の注意事項

### コーディング規約
- 全てのコメントは日本語で記述
- Rustのベストプラクティスに従う
- 同期I/Oを使用（正確な測定のため）

### エラーハンドリング
- ファイルI/O操作は必ずエラーチェック
- 親ディレクトリの存在を事前確認
- ユーザーへのエラーメッセージは日本語で明確に

### テスト戦略
- 実装変更時は`test_program`で動作確認
- フルベンチマークは最終確認時のみ実行
- CI/CD環境では軽量テストのみ実行推奨

### パフォーマンス考慮事項

#### 測定の正確性
- 同期I/Oを使用（非同期処理はバッファリングの影響を受ける）
- `Instant::now()`で高精度な時間測定
- ファイル作成ループの前後で時間を測定

#### 実装パターン
```rust
// 時間測定の開始
let start = Instant::now();

// ファイル作成処理
for i in 0..file_count {
    let file_path = base_path.join(format!("file_{:08}.dat", i));
    let mut file = File::create(&file_path)?;
    file.write_all(&data)?;
}

// 時間測定の終了
let elapsed = start.elapsed();
```

## 期待される結果

### 一般的な性能傾向

| ストレージ種類 | 処理速度 | 特徴 |
|--------------|---------|------|
| NVMe SSD | 10,000-30,000 ファイル/秒 | 最高性能、ランダムI/Oに強い |
| SATA SSD | 5,000-15,000 ファイル/秒 | 高性能、コストパフォーマンス良好 |
| HDD | 500-2,000 ファイル/秒 | シーク時間の影響大 |
| ネットワーク | 100-1,000 ファイル/秒 | ネットワーク帯域とレイテンシに依存 |

### 性能に影響する要因
1. **ハードウェア**:
   - ディスクの種類（NVMe/SATA/HDD）
   - インターフェース速度
   - キャッシュサイズ

2. **ソフトウェア**:
   - ファイルシステムの種類（NTFS/ext4/XFS）
   - マウントオプション
   - OSのバッファキャッシュ設定

3. **システム状態**:
   - ディスクの使用率
   - 同時実行中の他のI/O処理
   - 断片化の状態

## プロジェクト目的

本ベンチマークツールは以下の判断材料を提供します：

- **ストレージ性能評価**: 異なるストレージの定量的な性能比較
- **ファイルシステム評価**: 大量の小ファイル処理における最適なファイルシステム選定
- **システム設計指針**: バックアップ、ログ、キャッシュシステムの性能予測
- **コスト対性能評価**: ストレージ投資の判断材料

### ユースケース

#### ストレージ選定
- サーバー用ストレージの性能評価
- クラウドストレージとローカルストレージの比較
- RAID構成の最適化

#### システム設計
- 大量ログファイル生成システムの性能予測
- バックアップシステムのスループット評価
- キャッシュストレージの選定

#### 性能最適化
- ファイルシステムの比較（NTFS vs ext4 vs XFS）
- マウントオプションの調整効果測定
- ブロックサイズの最適化

### 書籍「datamanagement」での活用
- ストレージ性能の定量的理解
- データ管理戦略におけるストレージ選定の重要性
- 大量ファイル処理システムの設計指針
- コスト対性能のトレードオフ分析
